## Агент для протоколов ЭхоКГ (КОШКА)

Этот агент работает с шаблонами и приложениями к протоколу эхокардиографии для кошек в папке `кошка`.

### Контекст и файлы

- **`ЭхоКГ протокол стандарт_КОШКА.pdf` / `ЭхоКГ протокол стандарт_КОШКА.txt`**  
  - Стандартный бланк протокола ЭхоКГ кошки.  
  - Структура полей (по `.txt`):  
    - Блок пациента: вид, порода, кличка, пол, возраст, чип, масса тела, седация.  
    - `ЛЕВОЕ ПРЕДСЕРДИЕ`: ЛП max, Ао, ЛП/Ао, ЛП/АО, спонтанное контрастирование.  
    - `СОСУДЫ МКК`: ЛВ, ПВЛА, ЛВ/ПВЛА, В‑линии.  
    - `ЛЕВЫЙ ЖЕЛУДОЧЕК`: МЖПд, ЗСЛЖд, КДР, КСР, ФУ, локальная гипертрофия, папиллярные мышцы.  
    - `ПРАВОЕ ПРЕДСЕРДИЕ`: ПП, визуальная оценка.  
    - `ПРАВЫЙ ЖЕЛУДОЧЕК`: ПЖ, СПЖд, ПЖ/ЛЖ, СПЖ/ЗСЛЖ, SAM, ФУ в %.  
    - Клапаны: митральный, аортальный, трикуспидальный, клапан лёгочной артерии (створки, скорости E/A, IVRT, E′, A′, E/E′, степени регургитации, градиенты `4*v^2` в мм рт. ст.).  
    - Блок шунтов: ДМПП, ДМЖП, ОАП, направление сброса, скорость, градиенты, описание шунта.  
    - Прочее: полость перикарда, свободная жидкость в грудной полости, зоны гипо-/акинеза, координация сократительной активности миокарда, признаки патологического шунтирования.  
    - Комментарии и заключение, подпись врача и дата.  
  - Явно указана формула фракции укорочения: `(КДР – КСР) /КДР × 100 %`.  
  - В конце: формат протокола рекомендован Кардиологическим Ветеринарным Обществом, протокол *не является кардиологическим диагнозом* и должен рассматриваться вместе с другими исследованиями.

- **`ЭхоКГ протокол стандарт_КОШКА.xlsx`**  
  - Табличная (Excel) версия стандартного протокола с теми же показателями, предназначена для заполнения.  
  - Логические связи и расчёты берутся не «с нуля», а из заранее распарсенного JSON: `ЭхоКГ протокол стандарт_КОШКА.parsed.json`, полученного скриптом `parse_koshka_xlsx.py` (через `openpyxl`).  
  - В `.parsed.json` для каждого листа доступны:
    - Полный плоский список ячеек (`coord` + `value`), соответствующий текстовому шаблону.  
    - Список формул (`coord`, `formula`), которые нужно по возможности воспроизводить в коде/калькуляторе один в один.

- **`Приложение к протоколуЭхоКГ_Кошка.pdf` / `Приложение к протоколуЭхоКГ_Кошка.txt`**  
  - Методическое приложение Кардиологического Ветеринарного Общества к рекомендованному протоколу ЭхоКГ кошек.  
  - Содержит:  
    - Примечания по методике измерений (ЛП max, ЛП/Ао, морфометрия ЛЖ в диастолу/систолу, оценка правых отделов, динамической обструкции ВТЛЖ, В‑линий и плеврального выпота и др.).  
    - Формулы расчёта функциональных и геометрических параметров.  
    - Рекомендованные эхокардиографические сечения для каждого показателя.  
    - Референтные интервалы (нормы, «серые зоны», пороги патологии) и используемые сокращения.
  - Использовать как основной источник нормативов и методических пояснений, содержимое не править.

### Язык и стиль

- **Основной язык**: русский.  
- **Терминология**: сохранять ветеринарные термины и сокращения в том виде, как в протоколе:
  - ЛП, Ао, ЛВ, ЛА, ПВЛА, ПП, ПЖ, МЖП, ЗСЛЖ, СПЖ, КДР, КСР, ФУ, E, A, E/A, IVRT, E′, A′, E/E′ и т.д.  
- **Формат чисел**:
  - В шаблонах может использоваться запятая как разделитель дробной части; при расчётах можно оперировать точкой, но в выводе для врача корректнее использовать запятую.

### Цели агента в этой папке

- **Не менять исходные медицинские шаблоны** (`*.pdf`, `*.xlsx`):
  - Не переписывать и не переформатировать эти файлы.  
  - Не пытаться «чистить» извлечённый из них текст — использовать его только как ориентир по структуре и полям.

- **Помогать строить инструменты вокруг протоколов**:
  - Генерировать текстовые описания, подсказки и калькуляторы, которые используют те же поля и обозначения, что и в стандартном протоколе для кошек.  
  - Если требуется автоматизация (формы, скрипты, шаблоны отчётов), структура должна быть как можно ближе к `ЭхоКГ протокол стандарт_КОШКА` (блоки камер, клапанов, сосудов, шунтов, заключение, комментарии).

- **Соблюдать медицинские ограничения**:
  - Не придумывать произвольные референсные значения; при отсутствии точных норм явно указывать, что значения условны или требуют сверки с литературой/нормативами.  
  - Подчёркивать, что автоматически сгенерированный текст **не является окончательным диагнозом** и должен интерпретироваться врачом совместно с клиническими данными (по аналогии с ремаркой в PDF).

### Использование формул и показателей

- **Фракция укорочения** (ФУ, FS):
  - Формула: `(КДР – КСР) / КДР × 100 %`.  
  - При генерации кода или пояснений использовать именно такую запись, чтобы она совпадала с привычной для врачей.

- **Другие показатели**:
  - При ссылке на скорости и отношения использовать те же обозначения, что в шаблоне:
    - `E`, `A`, `E/A` для митрального и трикуспидального клапана.  
    - `IVRT`, `E′`, `A′`, `E/E′` для диастолической функции.  
    - `4*v^2` в мм рт. ст. для расчёта градиентов.  
  - При необходимости добавлять в текст расшифровку аббревиатур, но не менять сами сокращения.

#### Кратко о референтных интервалах (для ориентира)

Использовать **исходные таблицы из `Приложение к протоколуЭхоКГ_Кошка.txt`** как источник истины; значения ниже приведены только для понимания структуры и не должны заменять оригинал:

- **Левое предсердие**:  
  - ЛП max ≤ 16 мм — норма; >16 мм — патология.  
  - ЛП/Ао ≤ 1,5 — норма; >1,5 — патология.  
  - Скорость в ушке ЛП >0,25 м/с — норма; ≤0,25 м/с — замедление наполнения/опорожнения.  
  - ФС ЛП (фракция сократимости): (ЛПмакс – ЛПмин)/ЛПмакс × 100 %, норма >25%.

- **Сосуды малого круга**:  
  - ЛВ/ПВЛА 0,9–1,0 — норма; >1,0 — признак венозного застоя малого круга.

- **Левый желудочек**:  
  - ЗСЛЖд и МЖПд <5 мм — норма; 5–6 мм — «серая зона»; >6 мм — гипертрофия.  
  - MAPSE ≥ 3,2 мм — норма; <3,2 мм — снижение продольной сократимости ЛЖ.

- **Правое предсердие и правый желудочек**:  
  - ППмакс 11,46–13,72 мм — норма.  
  - СПЖ (толщина свободной стенки ПЖ) 2,24–3,3 мм — норма.  
  - ПЖд 4,42–9,08 мм — референтный диапазон (смотри оригинальную таблицу).  
  - TAPSE ≥ 6,4 мм — норма; <6,4 мм — дисфункция ПЖ.

- **Диастолическая функция (тканевой допплер и трансмитральный поток)**:  
  - E′ латеральное ≥ 6 см/с — норма; <6 см/с — признак аномальной релаксации ЛЖ.  
  - IVRT 40–60 мс — норма.  
  - E/E′ >15 — корреляция с застоем в малом круге при ГКМП.  
  - E/A ≤ 1,77 — норма; >1,77 — корреляция с застоем в малом круге при ГКМП.

#### Кратко о формулах из Excel (по `.parsed.json`)

При реализации калькулятора для кошек приоритет — повторять именно Excel‑формулы из `ЭхоКГ протокол стандарт_КОШКА.parsed.json` (а не придумывать новые эквиваленты). Примеры ключевых вычислений:

- **Отношения размеров**:
  - ЛП/Ао: формула вида `=B11/B12`.  
  - ЛВ/ПВЛА: формула вида `=B15/B16`.  
  - Соотношение диаметров сосудов и камер (например, `=B32/B33`, `=B32*100/B35` и др.) — использовать те же деления/умножения, что в Excel.

- **Сократимость и фракции**:
  - ФУ (фракция укорочения) по Excel: `=((B23-B24)/B23)*100`, что соответствует `(КДР – КСР)/КДР × 100 %`.  
  - Дополнительные процентные отношения (например, `=B28/B23*100`) также следует переносить напрямую.

- **Градиенты по допплеру**:
  - Для расчёта градиентов используется базовая формула `4*v^2` (в мм рт. ст.), в Excel она представлена как `=4*(B39^2)`, `=4*(B43^2)`, `=4*(B49^2)`, `=4*(B52^2)`, `=4*(B57^2)` и др.  
  - При переносе в код/JS рекомендуется сохранять именно такую запись: `4 * (v ** 2)` для соответствующего поля скорости.

Если требуется более точное сопоставление полей (какая ячейка `B23` соответствует какому клиническому параметру), сначала смотреть структуру `.txt`/`.pdf` и маппинг координат из `ЭхоКГ протокол стандарт_КОШКА.parsed.json`, а уже затем переносить формулы.

### Как интерпретировать недоступные данные

- **Если какое‑то поле/норма есть только в приложении или Excel**, но точное значение недоступно агенту:
  - Не «выдумывать» конкретные цифры.  
  - Можно оставить заготовку вида:  
    - «Норма для данного показателя должна быть уточнена по `Приложение к протоколуЭхоКГ_Кошка.pdf` или `ЭхоКГ протокол стандарт_КОШКА.xlsx`».  

- **При проектировании новых форм для кошек**:
  - Базироваться на списке полей, видимом в PDF‑шаблоне (ЛП, Ао, ЛВ, ПП, ПЖ, МЖП, ЗСЛЖ, СПЖ, ЛВ/ПВЛА, ЛП/Ао, клапаны, шунты, заключение).  
  - Сохранять структуру разделов: камеры, клапаны, сосуды МКК, шунты, прочее, заключение, комментарии.

### Готовые инструменты в репозитории

- **Вкладка "Для кошек" в `index.html`**  
  - Содержит только заглушку и ссылку на отдельную страницу кошачьего калькулятора.  
  - Основной (старый) калькулятор в `index.html` сохраняется для обратной совместимости и не должен меняться при правках, связанных с кошками.

- **Страница `cat_calc.html` — калькулятор ЭхоКГ для кошек**  
  - Реализует протокол по шаблону Кардиологического Ветеринарного Общества, опираясь на структуру блоков `ЭхоКГ протокол стандарт_КОШКА` и данные из приложения.  
  - Основные разделы и поля:
    - **Общие данные**: масса тела, ЧСС, седация (да/нет).  
    - **Левое предсердие**: ЛП max по короткой и длинной осям, Ао, расчёт ЛП/Ао, спонтанное контрастирование (да/нет).  
    - **Сосуды МКК**: ЛВ, ПВЛА, расчёт ЛВ/ПВЛА, В‑линии (да/нет).  
    - **Левый желудочек**: МЖПд и ЗСЛЖд в короткой и длинной осях, КДР, КСР, автоматический расчёт ФУ по формуле Excel, оценка папиллярных мышц и локальной гипертрофии.  
    - **Правые отделы**: ПП (числовой размер и визуальная оценка), ПЖ и СПЖд с автоматическими отношениями ПЖ/ЛЖ и СПЖ/ЗСЛЖ в процентах.  
    - **Клапанный аппарат**: митральный и трикуспидальный клапаны (скорости E/A, IVRT, E′/A′, расчёт E/A и E/E′), скорости регургитации и градиенты по `4*v^2`.  
    - **Аорта и лёгочная артерия**: створки, стеноз, описание ВТЛЖ/ВТПЖ, размеры фиброзных колец и ствола, отношение Ао/ЛА, скорости потока и регургитации с градиентами по формуле `4*v^2`.  
    - **Патологическое шунтирование**: текстовые поля для ДМПП, ДМЖП, ОАП.  
  - Вся логика расчётов реализована на JavaScript с прицелом на максимальное соответствие Excel‑формулам (`ЛП/Ао`, `ЛВ/ПВЛА`, ФУ, градиенты `4*v^2` и др.).  
  - Поля, помеченные как вычисляемые, обновляются **динамически по вводу** (обработчики `input`), без необходимости повторно нажимать кнопку «Рассчитать».  
  - Отдельные функции отвечают за:
    - валидацию ввода и показ ошибок/успешных сообщений;  
    - формирование текстового протокола по заполненным полям;  
    - копирование итогового текста в буфер обмена.  

- **Скрипт `parse_koshka_xlsx.py`**  
  - Используется для разбора `ЭхоКГ протокол стандарт_КОШКА.xlsx` и получения `.parsed.json` с формулами и структурой листов.  
  - При необходимости доработки калькулятора для кошек агенту следует сначала смотреть на актуальный вывод этого скрипта, затем переносить/уточнять формулы в JavaScript.

### Ограничения и приоритеты

- **Приоритет**: точность терминологии и уважение к существующим шаблонам выше, чем визуальные или технические «улучшения».  
- **Никогда не интерпретировать эти файлы как «просто произвольный текст»** — они являются медицинскими документами.  
- Все автоматические выводы, диагнозы и интерпретации должны сопровождаться фразой, что итоговое заключение остаётся за лечащим врачом.

