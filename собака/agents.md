## Агент для протоколов ЭхоКГ (СОБАКА)

Этот агент работает с шаблонами и приложениями к протоколу эхокардиографии для собак в папке `собака`.

### Контекст и файлы

- **`ЭХОКГ протокол стандарт_СОБАКА.txt` / `ЭхоКГ протокол стандарт_СОБАКА.xlsx` / `ЭхоКГ протокол стандарт_СОБАКА.parsed.json`**  
  - Стандартный бланк протокола ЭхоКГ собаки (рекомендованный Кардиологическим Ветеринарным Обществом).  
  - Структура полей по `.txt`/Excel аналогична кошачьему протоколу, но с учётом специфики собак и дополнительных индексов (нормализованные размеры по массе тела, объёмы по Симпсону, EPIC‑критерии и т.п.).  
  - Базовые блоки:
    - Блок пациента: вид, порода, кличка, пол, возраст, чип, масса тела, седация.  
    - `ЛЕВОЕ ПРЕДСЕРДИЕ`: ЛП max, Ао, ЛП/Ао, ЛП нормализованный (индексированный), спонтанное контрастирование.  
    - `СОСУДЫ МКК`: ЛВ, ПВЛА, ЛВ/ПВЛА, В‑линии.  
    - `ЛЕВЫЙ ЖЕЛУДОЧЕК`: КДР, КСР, индексированные размеры (КДРн, КСРн), ФУ, объёмы (КДО, КСО, фракция выброса), EPSS и др.  
    - `ПРАВОЕ ПРЕДСЕРДИЕ И ПРАВЫЙ ЖЕЛУДОЧЕК`: ПП, размеры ПЖ и СПЖ, индексы ПЖ/ЛЖ, СПЖ/ЗСЛЖ, TAPSE, FAC и т.д.  
    - Клапаны: митральный, аортальный, трикуспидальный, клапан лёгочной артерии (створки, скорости допплеровских потоков, степени регургитации, градиенты по формуле `4*v^2`).  
    - Блок шунтов: ДМПП, ДМЖП, ОАП, направление сброса, скорость, градиенты, описание шунта.  
    - Прочее: полость перикарда, свободная жидкость в грудной/брюшной полости, признаки венозного застоя, комментарии и заключение, подпись врача и дата.  
  - Файл `ЭхоКГ протокол стандарт_СОБАКА.parsed.json` (генерируется скриптом `parse_koshka_xlsx.py`) содержит:
    - Полный список ячеек (координата + значение) для каждого листа.  
    - Отдельный список формул Excel, которые следует по возможности дословно переносить в код/калькулятор.

- **`Приложение к протоколу ЭхоКГ собаки.txt`**  
  - Методическое приложение Кардиологического Ветеринарного Общества к протоколу ЭхоКГ собак.  
  - Содержит:
    - Подробные примечания по методике измерений (ЛП/Ао, метод Симпсона для объёмов ЛЖ, оценка правых отделов, динамическая обструкция ВТЛЖ, оценка В‑линий, лёгочной гипертензии и др.).  
    - Формулы расчёта функциональных и геометрических параметров, в т.ч. индексированные показатели по массе тела (МТ) и площади поверхности тела (ППТ).  
    - Референтные интервалы (нормы, пороги патологии, «серые зоны») для ключевых показателей.  
  - Используется как основной источник норм и методических пояснений для собак; содержимое изменять нельзя.

### Язык и стиль

- **Основной язык**: русский.  
- **Терминология**: использовать те же сокращения и обозначения, что в протоколе и приложении:
  - ЛП, Ао, ЛВ, ПВЛА, ПП, ПЖ, СПЖ, КДР, КСР, КДО, КСО, ФУ, ФВ, EPSS, TAPSE, FAC, ППТ, МТ, ДКМП и т.д.  
- **Формат чисел**:
  - Допускается использование запятой как разделителя дробной части в текстовых выводах, но в формулах/коде использовать точку.

### Цели агента в папке `собака`

- **Не менять исходные медицинские шаблоны** (`*.txt`, `*.xlsx`):
  - Не переписывать и не упрощать текст протоколов и приложений.  
  - Не модифицировать структуру Excel‑шаблона, использовать его только как источник структуры и формул.

- **Помогать строить инструменты вокруг протокола собак**:
  - Проектировать формы ввода, калькуляторы и текстовые шаблоны заключений, строго следуя полям и блокам стандартного протокола для собак.  
  - При необходимости добавлять подсказки по интерпретации (например, что ЛП/Ао > 1,6 выходит за норму), но всегда ссылаться на приложение как на источник норм.

- **Соблюдать медицинские ограничения**:
  - Не придумывать новые референтные значения; опираться на приведённые в приложении диапазоны (ЛП/Ао, индексированные размеры ЛЖ, объёмы по Симпсону, TAPSE/Ао и т.п.).  
  - Подчёркивать, что автоматически сгенерированный текст **не является окончательным диагнозом** и должен интерпретироваться врачом совместно с клиническими данными и другими исследованиями.

### Использование формул и показателей (по приложению и Excel)

- **Фракция укорочения (ФУ)**:
  - Базовая формула: `((КДР – КСР) / КДР) × 100 %` (как в приложении).  
  - В Excel‑шаблоне реализована как формула вида `=((B19-B21)/B19)*100` или аналогичная, её и следует повторять в коде.

- **Индексированные размеры ЛЖ** (по массе тела):
  - КДРн (нормализованный КДР): `КДР / МТ⁰·²⁹⁴`, в Excel: `=(0.1*B19)/B8^0.294`.  
  - КСРн (нормализованный КСР): `КСР / МТ⁰·³²`, в Excel: `=(0.1*B21)/B8^0.315`.  
  - Нормативы из приложения: КДРн ≤ 1,7; КСРн ≤ 1,0 (индексированные значения).  

- **Левое предсердие и сосуды малого круга**:
  - ЛП/Ао: формула вида `=B11/B12`, норма ≤ 1,6 (EPIC‑критерий).  
  - ЛПмакс/МТ⁰·³⁰⁹: индексированный ЛП (формула в Excel представлена как степень по МТ).  
  - ЛВ/ПВЛА: формула вида `=B14/B15`, норма 0,9–1,2; >1,7 — выраженный венозный застой малого круга.

- **Объёмы ЛЖ и фракция выброса (метод Симпсона, для пород с риском ДКМП)**:
  - КДО/кг, КСО/кг, КДО/ППТ, КСО/ППТ по референтным интервалам для доберманов и боксёров (как в приложении).  
  - ФВ: `((КДО – КСО) / КДО) × 100 %`. В Excel соответствует формуле вида `=((B23-B24)/B23)*100`.  
  - При переносе в код следует воспроизводить именно Excel‑формулы из `.parsed.json`.

- **Показатели правых отделов**:
  - Отношения ПЖ/ЛЖ и СПЖ/ЗСЛЖ: формулы вида `=B34/B35`, `=B34/(B37/100)`, `=B34*100/B38` с референтными интервалами 30–50 %.  
  - TAPSE/Ао: `TAPSE (мм) / диаметр аорты (мм)` с нормой > 0,65. В Excel представлено как отношение соответствующих ячеек.

- **Градиенты по допплеру**:
  - Во всех блоках клапанов и выносящих трактов используется формула `4*v^2` (мм рт. ст.), соответствующая Excel‑формулам `=4*(B42^2)`, `=4*(B46^2)`, `=4*(B50^2)`, `=4*(B54^2)`, `=4*(B58^2)`, `=4*(E75^2)` и т.п.  
  - В коде/JS рекомендуется использовать форму `4 * (v ** 2)` или эквивалентную, явно указывая, что результат в мм рт. ст.

#### Референтные интервалы (для ориентира, см. приложение)

Использовать **значения из `Приложение к протоколу ЭхоКГ собаки.txt`** как источник истины; ниже — только краткое резюме структуры норм:

- **Левое предсердие**:  
  - ЛП/Ао ≤ 1,6 — норма (EPIC); диапазон 1,19–1,56 для индексированного ЛП (ЛПмакс / МТ⁰·³⁰⁹).  

- **Левый желудочек**:  
  - КДРн ≤ 1,7; КСРн ≤ 1,0.  
  - ФУ ≥ 20–25 %.  
  - Специфические пороговые значения КДР/КСР для самцов/самок (например, КДР ≥ 48 мм у самцов и ≥ 46 мм у самок — патология; КСР ≥ 36 мм — патология).  

- **Объёмы ЛЖ (метод Симпсона) и ДКМП‑критерии**:  
  - КДО/кг, КСО/кг, ФВ и индексированные по ППТ объёмы (отдельно для доберманов и боксёров) с порогами патологии, как в приложении.  

- **Правые отделы и системные вены**:  
  - ПЖ/ЛЖ и СПЖ/ЗСЛЖ 30–50 %.  
  - TAPSE/Ао > 0,65.  
  - Спадение каудальной полой вены (КПВ) <33 % ассоциируется с асцитным выпотом при правосторонней ЗСН (формула: `((КПВ на выдохе – КПВ на вдохе) / КПВ на выдохе) × 100 %`).  

При проектировании любых новых форм или логики для собак:
- базироваться на полях и формулах из `ЭхоКГ протокол стандарт_СОБАКА.parsed.json`;  
- сверять интерпретацию и пороги с текстом `Приложение к протоколу ЭхоКГ собаки.txt`;  
- не добавлять «свои» диагнозы и нормы поверх официальных рекомендаций.

